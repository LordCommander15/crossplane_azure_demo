###############################################################################
# CI Pipeline — lint, validate, build & push
#
# Triggers on pushes and PRs that touch application code, Helm charts,
# Crossplane manifests, or bootstrap resources.
###############################################################################
name: CI

on:
  push:
    branches: [main]
    paths:
      - "apps/**"
      - "infrastructure/**"
      - "platform/**"
      - "bootstrap/**"
  pull_request:
    branches: [main]
    paths:
      - "apps/**"
      - "infrastructure/**"
      - "platform/**"
      - "bootstrap/**"

env:
  REGISTRY: docker.io
  IMAGE_NAME: lordcommander15/dashboard

jobs:
  ###########################################################################
  # 1. Lint & Validate YAML / Helm
  ###########################################################################
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Helm lint — dashboard chart
        run: helm lint apps/dashboard/helm-chart

      - name: Helm lint — ingress chart
        run: helm lint platform/services/ingress/chart -f platform/services/ingress/values.yaml

      - name: Helm lint — harbor chart
        run: helm lint platform/services/harbor/chart -f platform/services/harbor/values.yaml

      - name: Install kubeconform
        run: |
          curl -fsSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Validate Crossplane manifests (YAML syntax)
        run: |
          kubeconform \
            --strict \
            --ignore-missing-schemas \
            --summary \
            infrastructure/definitions/ \
            infrastructure/compositions/ \
            infrastructure/providers/

      - name: Validate bootstrap manifests
        run: |
          kubeconform \
            --strict \
            --ignore-missing-schemas \
            --summary \
            bootstrap/

  ###########################################################################
  # 2. Build & Push Docker image (main branch only)
  ###########################################################################
  build-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate image tag
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TAG="$(date +%Y%m%d)-${SHORT_SHA}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Image tag: ${TAG}"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: apps/dashboard
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update image tag in Helm values
        run: |
          sed -i "s|^  tag:.*|  tag: \"${{ steps.meta.outputs.tag }}\"|" \
            apps/dashboard/helm-chart/values.yaml

      - name: Commit updated image tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/dashboard/helm-chart/values.yaml
          # Only commit if there are changes
          git diff --cached --quiet || \
            git commit -m "ci: bump dashboard image to ${{ steps.meta.outputs.tag }}"
          git push
